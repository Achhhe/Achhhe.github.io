<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>展分析：当$&#92;beta &#92;in (0,2)$时，$I - &#92;beta k k^T$的特征值特性变化</title>
      <link href="/2026/02/08/260208-deltanet-transition-matrix-analysis-2/"/>
      <url>/2026/02/08/260208-deltanet-transition-matrix-analysis-2/</url>
      
        <content type="html"><![CDATA[<div class="markmap-container" style="height:400px">  <svg data="{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;前提条件回顾&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;特征值推导&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;分区间特性分析&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;（0,1）：定向更新k方向，增量平滑修正&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;【1, 2）：反向修正，强制覆盖&quot;}]},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[6,7]},&quot;v&quot;:&quot;实验验证&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[7,8]},&quot;v&quot;:&quot;物理意义&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[8,9]},&quot;v&quot;:&quot;结论&quot;}],&quot;p&quot;:{}}"></svg></div><blockquote><p>脑图可拖动和放缩</p></blockquote><p>前文已分析$\beta \in (0,1)$时$I - \beta k k^T$的特征值特性，本文将$\beta$的取值范围扩展到$(0,2)$，拆解不同区间内的特性变化、物理意义及对 DeltaNet 算法的影响，为实际调参与应用提供参考。</p><h2 id="一、前提条件回顾"><a href="#一、前提条件回顾" class="headerlink" title="一、前提条件回顾"></a>一、前提条件回顾</h2><p>仍沿用以下基础定义（与 DeltaNet 算法场景一致）：</p><ul><li><p>$I$：$d \times d$ 单位矩阵（$d = d_k$，键向量维度）；</p></li><li><p>$k$：$d \times 1$ 列向量，满足 L2 归一化（$k^T k = 1$）；</p></li><li><p>$k k^T$：$d \times d$ 秩 1 对称矩阵；</p></li><li><p>$\beta$：常数，取值范围扩展为 $(0,2)$</p></li></ul><h2 id="二、特征值推导（扩展版）"><a href="#二、特征值推导（扩展版）" class="headerlink" title="二、特征值推导（扩展版）"></a>二、特征值推导（扩展版）</h2><p>延续之前的推导逻辑，核心结论不变，但需结合$\beta$的区间拆分特性：</p><ol><li><p>秩 1 矩阵 $k k^T$ 的特征值仍为：1 个非零特征值$\lambda_1=1$（对应特征向量$k$），$d-1$个零特征值；</p></li><li><p>目标矩阵 $I - \beta k k^T$ 的特征值仍满足 $\lambda_A = 1 - \beta \cdot \lambda_B$，因此：</p></li></ol><ul><li><p>对应$k$方向的特征值：$\lambda_1’ = 1 - \beta$；</p></li><li><p>对应正交方向的特征值：$\lambda_2’ = … = \lambda_d’ = 1$（无变化）。</p></li></ul><p>关键差异在于：$\lambda_1’ = 1 - \beta$ 的取值会随$\beta$跨区间变化，进而导致矩阵性质与物理意义改变。</p><h2 id="三、分区间特性分析（核心内容）"><a href="#三、分区间特性分析（核心内容）" class="headerlink" title="三、分区间特性分析（核心内容）"></a>三、分区间特性分析（核心内容）</h2><p>按$\beta$的取值分为两个区间：$\beta \in (0,1)$（原区间）和$\beta \in [1,2)$（新增区间），对比分析特性变化。</p><h3 id="3-1-区间-1：-beta-in-0-1-（基准区间）"><a href="#3-1-区间-1：-beta-in-0-1-（基准区间）" class="headerlink" title="3.1 区间 1：$\beta \in (0,1)$（基准区间）"></a>3.1 区间 1：$\beta \in (0,1)$（基准区间）</h3><p>特征值特性与前文一致，此处仅做简要总结：</p><table><thead><tr><th>特征值类型</th><th>取值</th><th>矩阵性质</th><th>物理意义（DeltaNet 语境）</th></tr></thead><tbody><tr><td>$k$方向特征值</td><td>$1 - \beta \in (0,1)$</td><td>正定矩阵、非膨胀收缩矩阵</td><td>定向更新：保留$1-\beta$历史记忆，更新$\beta$新信息</td></tr><tr><td>正交方向特征值</td><td>1</td><td>-</td><td>无更新：完全保留无关记忆</td></tr></tbody></table><h3 id="3-2-区间-2：-beta-in-1-2-（新增区间）"><a href="#3-2-区间-2：-beta-in-1-2-（新增区间）" class="headerlink" title="3.2 区间 2：$\beta \in [1,2)$（新增区间）"></a>3.2 区间 2：$\beta \in [1,2)$（新增区间）</h3><p>当$\beta \geq 1$时，$k$方向的特征值$\lambda_1’ = 1 - \beta$进入$(-1, 0]$区间，导致核心特性发生本质变化</p><h4 id="特征值取值与矩阵性质"><a href="#特征值取值与矩阵性质" class="headerlink" title="特征值取值与矩阵性质"></a>特征值取值与矩阵性质</h4><table><thead><tr><th>特征值类型</th><th>取值范围</th><th>矩阵性质变化</th></tr></thead><tbody><tr><td>$k$方向特征值</td><td>$1 - \beta \in (-1, 0]$</td><td>1. 不再是正定矩阵（存在非正特征值）；<br>2. 仍为非膨胀矩阵（特征值绝对值 &lt;1）；<br>3. 当$\beta=1$时，$\lambda_1’=0$（矩阵奇异）； <br>4. 当$\beta \in (1,2)$时，$\lambda_1’ \in (-1,0)$（矩阵负定分量）</td></tr><tr><td>正交方向特征值</td><td>1（无变化）</td><td>-</td></tr></tbody></table><h4 id="核心特性变化（与-beta-in-0-1-对比）"><a href="#核心特性变化（与-beta-in-0-1-对比）" class="headerlink" title="核心特性变化（与$\beta \in (0,1)$对比）"></a>核心特性变化（与$\beta \in (0,1)$对比）</h4><h5 id="变化-1：从-“定向更新”-变为-“定向翻转修正”"><a href="#变化-1：从-“定向更新”-变为-“定向翻转修正”" class="headerlink" title="变化 1：从 “定向更新” 变为 “定向翻转修正”"></a>变化 1：从 “定向更新” 变为 “定向翻转修正”</h5><ul><li><p>$\beta \in (0,1)$时：$k$方向特征值为正，记忆更新是 “历史记忆 + 误差修正” 的叠加（增量修正）；</p></li><li><p>$\beta \in (1,2)$时：$k$方向特征值为负，记忆更新变为 “翻转历史记忆 + 误差修正”（反向修正），即：</p><p>$S_t = S_{t-1} + \beta (v_t - S_{t-1}k_t)k_t^T = S_{t-1}(I - \beta k k^T) + \beta v_t k_t^T$</p><p>当$I - \beta k k^T$在$k$方向为负时，$S_{t-1}$中与$k$相关的记忆会被反向缩放后再叠加新误差，相当于 “否定旧记忆后重新学习”。</p></li></ul><h5 id="变化-2：矩阵正定性丧失，更新稳定性下降"><a href="#变化-2：矩阵正定性丧失，更新稳定性下降" class="headerlink" title="变化 2：矩阵正定性丧失，更新稳定性下降"></a>变化 2：矩阵正定性丧失，更新稳定性下降</h5><ul><li><p>$\beta \in (0,1)$时，矩阵正定，记忆更新过程中数值无震荡（非膨胀 + 全正特征值）；</p></li><li><p>$\beta \in [1,2)$时，矩阵非正定：</p><ul><li><p>$\beta=1$时，$k$方向特征值为 0，矩阵奇异（行列式为 0），此时与$k$相关的记忆更新会 “完全覆盖”（无历史保留）；</p></li><li><p>$\beta \in (1,2)$时，$k$方向特征值为负，多次更新后可能出现数值震荡（反向修正叠加），但因特征值绝对值，不会出现无限膨胀。</p></li></ul></li></ul><h5 id="变化-3：记忆更新强度的-“超调效应”"><a href="#变化-3：记忆更新强度的-“超调效应”" class="headerlink" title="变化 3：记忆更新强度的 “超调效应”"></a>变化 3：记忆更新强度的 “超调效应”</h5><ul><li><p>$\beta$越大，$k$方向特征值的绝对值越大（$\beta \to 2$时，$\lambda_1’ \to -1$），记忆更新的 “反向强度” 越强；</p></li><li><p>这种 “超调效应” 可能让模型快速修正错误记忆，但也可能因过度反向导致记忆不稳定（尤其长序列中）。</p></li></ul><h3 id="3-3-临界值：-beta-1"><a href="#3-3-临界值：-beta-1" class="headerlink" title="3.3 临界值：$\beta=1$"></a>3.3 临界值：$\beta=1$</h3><p>当$\beta=1$时，$k$方向特征值$\lambda_1’ = 0$，此时矩阵$I - k k^T$是<strong>投影矩阵</strong>（将向量投影到与$k$正交的子空间），特性如下：</p><ul><li><p>记忆更新公式简化为：$S_t = S_{t-1}(I - k k^T) + v_t k_t^T$；</p></li><li><p>物理意义：完全遗忘$S_{t-1}$中与$k$相关的旧记忆，直接存储当前$k$对应的新值$v_t$，相当于 “强制覆盖” 而非 “修正”。</p></li></ul><h2 id="四、实例验证（-beta-in-1-2-区间）"><a href="#四、实例验证（-beta-in-1-2-区间）" class="headerlink" title="四、实例验证（$\beta \in [1,2)$区间）"></a>四、实例验证（$\beta \in [1,2)$区间）</h2><p>以$\beta=1.5$（$\in (1,2)$）、$d=2$、$k = \begin{bmatrix} 1/\sqrt{2} \ 1/\sqrt{2} \end{bmatrix}$为例：</p><ol><li><p>计算外积矩阵 $k k^T = \begin{bmatrix} 1/2 &amp; 1/2 \ 1/2 &amp; 1/2 \end{bmatrix}$；</p></li><li><p>目标矩阵：$I - 1.5 k k^T = \begin{bmatrix} 1 &amp; 0 \ 0 &amp; 1 \end{bmatrix} - 1.5 \cdot \begin{bmatrix} 1/2 &amp; 1/2 \ 1/2 &amp; 1/2 \end{bmatrix} = \begin{bmatrix} 0.25 &amp; -0.75 \ -0.75 &amp; 0.25 \end{bmatrix}$；</p></li><li><p>求解特征值：通过特征方程得 $\lambda_1=1$，$\lambda_2=0.25 - 0.75 = -0.5 = 1 - 1.5$，符合推导结论（$k$方向特征值为负）。</p></li></ol><h2 id="五、对-DeltaNet-算法的实际影响"><a href="#五、对-DeltaNet-算法的实际影响" class="headerlink" title="五、对 DeltaNet 算法的实际影响"></a>五、对 DeltaNet 算法的实际影响</h2><h3 id="5-1-调参建议：-beta-为何通常设为-0-1-？"><a href="#5-1-调参建议：-beta-为何通常设为-0-1-？" class="headerlink" title="5.1 调参建议：$\beta$为何通常设为$(0,1)$？"></a>5.1 调参建议：$\beta$为何通常设为$(0,1)$？</h3><p>DeltaNet 的原始设计中$\beta \in (0,1)$，核心原因是：</p><ol><li><p>稳定性：正定矩阵保证记忆更新无震荡，适配超长序列的持续递推；</p></li><li><p>平滑修正：增量更新避免 “强制覆盖” 或 “反向翻转” 导致的记忆断裂；</p></li><li><p>可解释性：更新强度$\beta$直接对应 “新信息占比”，调参直观。</p></li></ol><h3 id="5-2-beta-in-1-2-的潜在应用场景"><a href="#5-2-beta-in-1-2-的潜在应用场景" class="headerlink" title="5.2 $\beta \in [1,2)$的潜在应用场景"></a>5.2 $\beta \in [1,2)$的潜在应用场景</h3><p>虽然稳定性下降，但该区间仍有特定价值：</p><ol><li><p>记忆纠错：当模型发现历史记忆存在严重错误时，可临时将$\beta$调至$[1,2)$，通过 “反向修正” 快速纠错；</p></li><li><p>短期强依赖任务：若任务需要模型快速遗忘旧键对应的记忆（如实时更新的推荐系统），$\beta=1$的 “强制覆盖” 模式更高效；</p></li><li><p>增强探索性：$\beta \in (1,2)$的 “超调效应” 可增加模型对新键值对的敏感度，适合少样本场景的快速学习。</p></li></ol><h3 id="5-3-风险提示"><a href="#5-3-风险提示" class="headerlink" title="5.3 风险提示"></a>5.3 风险提示</h3><ul><li><p>当$\beta \geq 2$时，$k$方向特征值$\lambda_1’ = 1 - \beta \leq -1$，矩阵变为 “膨胀矩阵”（特征值绝对值≥1），记忆更新会出现数值震荡且无限放大，导致模型发散，<strong>严格不建议使用</strong>；</p></li><li><p>即使$\beta \in (1,2)$，长序列中多次反向修正也可能导致记忆混淆，需配合 Gated DeltaNet 的$\alpha_t$（记忆衰减）机制平衡稳定性。</p></li></ul><h2 id="六、核心结论（-beta-in-0-2-全区间）"><a href="#六、核心结论（-beta-in-0-2-全区间）" class="headerlink" title="六、核心结论（$\beta \in (0,2)$全区间）"></a>六、核心结论（$\beta \in (0,2)$全区间）</h2><table><thead><tr><th>$\beta$区间</th><th>$k$方向特征值</th><th>矩阵核心性质</th><th>记忆更新模式</th><th>适用场景</th></tr></thead><tbody><tr><td>$(0,1)$</td><td>$(0,1)$</td><td>正定、非膨胀</td><td>增量平滑修正</td><td>绝大多数长序列建模场景</td></tr><tr><td>$[1,2)$</td><td>$(-1,0]$</td><td>非正定、非膨胀</td><td>反向修正 / 强制覆盖</td><td>记忆纠错、短期强依赖任务</td></tr><tr><td>$\geq 2$</td><td>$\leq -1$</td><td>非正定、膨胀</td><td>震荡发散</td><td>严格不适用</td></tr></tbody></table><p>关键总结：$\beta$的核心作用是<em><strong>控制$k$方向的记忆更新模式</strong></em>，$\in (0,1)$是 “安全区间”，$\in [1,2)$是 “风险 - 收益平衡区间”，$\geq 2$是 “禁用区间”。实际应用中需根据任务特性选择，建议优先在$(0,1)$区间调参（如$\beta=0.3 \sim 0.8$），仅在特定纠错场景尝试$\beta \in [1,2)$。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ToyDL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> Delta Rule </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DeltaNet 转移矩阵 $I - &#92;beta k k^T$ 的特性分析</title>
      <link href="/2026/02/08/260208-deltanet-transition-matrix-analysis-1/"/>
      <url>/2026/02/08/260208-deltanet-transition-matrix-analysis-1/</url>
      
        <content type="html"><![CDATA[<div class="markmap-container" style="height:400px">  <svg data="{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;基础定义&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;特征值推导&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;特征值核心特性&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;取值范围：（0,1）---&amp;gt; 转移矩阵是非膨胀收缩的正定矩阵&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;数量分布：仅两个特征值，与特征维度无关&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[6,7]},&quot;v&quot;:&quot;定向性：仅更新k方向&quot;}]},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[8,9]},&quot;v&quot;:&quot;实验验证&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[9,10]},&quot;v&quot;:&quot;物理意义&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[10,11]},&quot;v&quot;:&quot;保持记忆更新稳定性&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[11,12]},&quot;v&quot;:&quot;实现精准的定向记忆修正&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[12,13]},&quot;v&quot;:&quot;兼顾效率和性能&quot;}]},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[14,15]},&quot;v&quot;:&quot;结论&quot;}],&quot;p&quot;:{}}"></svg></div><blockquote><p>脑图可拖动和放缩</p></blockquote><p>在 DeltaNet 算法中，$I - \beta k k^T$ 是支撑记忆状态 $S_t$ 精准更新的核心运算结构，其特征值特性直接决定了记忆更新的稳定性、定向性与高效性。本文将结合 DeltaNet 的算法背景，详细拆解该矩阵的特征值推导过程与核心特性。</p><h2 id="一、基础定义与前提条件"><a href="#一、基础定义与前提条件" class="headerlink" title="一、基础定义与前提条件"></a>一、基础定义与前提条件</h2><p>首先明确矩阵中各符号的含义与约束条件（适配 DeltaNet 算法场景）：</p><ul><li><p>$I$：$d \times d$ 单位矩阵（$d$ 对应 DeltaNet 中键向量 $k_t$ 的维度 $d_k$）；</p></li><li><p>$k$：$d \times 1$ 的列向量，且满足 <strong>L2 归一化</strong>（即 $k^T k = |k|_2^2 = 1$），对应 DeltaNet 中当前 token 的键向量 $k_t$；</p></li><li><p>$k k^T$：$d \times d$ 的外积矩阵，因单个向量外积的秩为 1，故为 <strong>秩 1 对称矩阵</strong>；</p></li><li><p>$\beta$：常数，且满足 $0 &lt; \beta $，对应 DeltaNet 中的动态学习率（控制记忆更新强度）。</p></li></ul><h2 id="二、特征值推导过程"><a href="#二、特征值推导过程" class="headerlink" title="二、特征值推导过程"></a>二、特征值推导过程</h2><p>核心思路：先分析秩 1 矩阵 $k k^T$ 的特征值，再通过矩阵线性变换性质推导目标矩阵的特征值。</p><h3 id="步骤-1：分析秩-1-矩阵-k-k-T-的特征值"><a href="#步骤-1：分析秩-1-矩阵-k-k-T-的特征值" class="headerlink" title="步骤 1：分析秩 1 矩阵 $k k^T$ 的特征值"></a>步骤 1：分析秩 1 矩阵 $k k^T$ 的特征值</h3><p>由于 $k$ 是 L2 归一化列向量，$k k^T$ 作为秩 1 对称矩阵，其特征值满足以下性质：=</p><ul><li><p>唯一非零特征值：$\lambda_1 = k^T k = 1$（对应特征向量为 $k$ 本身）；</p></li><li><p>其余 $d-1$ 个特征值：$\lambda_2 = \lambda_3 = … = \lambda_d = 0$（对应特征向量均与 $k$ 正交，即满足 $v^T k = 0$）。</p></li></ul><h3 id="步骤-2：推导-I-beta-k-k-T-的特征值"><a href="#步骤-2：推导-I-beta-k-k-T-的特征值" class="headerlink" title="步骤 2：推导 $I - \beta k k^T$ 的特征值"></a>步骤 2：推导 $I - \beta k k^T$ 的特征值</h3><p>对于任意矩阵 $A = I - \beta B$（此处 $B = k k^T$），存在线性变换的特征值性质：</p><p>若 $B$ 的特征值为 $\lambda_B$，则 $A$ 的特征值为 $\lambda_A = 1 - \beta \cdot \lambda_B$。</p><p>结合步骤 1 的结论，可直接得到目标矩阵的特征值：</p><ul><li><p>对应特征向量 $k$ 的特征值：$\lambda_1’ = 1 - \beta \cdot 1 = 1 - \beta$；</p></li><li><p>对应所有与 $k$ 正交的特征向量的特征值：$\lambda_2’ = \lambda_3’ = … = \lambda_d’ = 1 - \beta \cdot 0 = 1$。</p></li></ul><h2 id="三、特征值的核心特性"><a href="#三、特征值的核心特性" class="headerlink" title="三、特征值的核心特性"></a>三、特征值的核心特性</h2><p>结合 $0 &lt; \beta &lt; 1$ 的约束条件，$I - \beta k k^T$ 的特征值具备以下 3 个关键特性：</p><h3 id="特性-1：取值范围-——-全部落在-0-1-区间"><a href="#特性-1：取值范围-——-全部落在-0-1-区间" class="headerlink" title="特性 1：取值范围 —— 全部落在 $(0, 1]$ 区间"></a>特性 1：取值范围 —— 全部落在 $(0, 1]$ 区间</h3><ul><li><p>特殊特征值 $1 - \beta$：因 $0 &lt; \beta &lt; 1$，故 $0 &lt; 1-\beta &lt; 1$</p></li><li><p>其余 $d-1$ 个特征值：均为 1（固定值）；</p></li><li><p>结论：矩阵所有特征值均大于 0 且不超过 1，因此 $I - \beta k k^T$ 是 <strong>正定矩阵</strong>（对称 + 所有特征值 &gt; 0），同时也是 <strong>非膨胀收缩矩阵</strong>（特征值绝对值≤1）。</p></li></ul><h3 id="特性-2：数量分布-——-仅两种取值，结构极简"><a href="#特性-2：数量分布-——-仅两种取值，结构极简" class="headerlink" title="特性 2：数量分布 —— 仅两种取值，结构极简"></a>特性 2：数量分布 —— 仅两种取值，结构极简</h3><p>无论维度 $d$ 多大（即使 $d=1024$ 或更高），特征值仅存在两种取值：</p><ul><li><p>1 个特殊值：$1 - \beta$（与当前键向量 $k$ 相关）；</p></li><li><p>$d-1$ 个固定值：1（与当前键向量 $k$ 无关）。</p></li></ul><p>这种简洁的分布特性，保证了 DeltaNet 中记忆更新的计算效率（无需复杂矩阵运算）。</p><h3 id="特性-3：定向性-——-仅对-k-方向的记忆进行更新"><a href="#特性-3：定向性-——-仅对-k-方向的记忆进行更新" class="headerlink" title="特性 3：定向性 —— 仅对 $k$ 方向的记忆进行更新"></a>特性 3：定向性 —— 仅对 $k$ 方向的记忆进行更新</h3><p>特征值的分布直接体现了 “定向更新” 的物理意义：</p><ul><li><p>$k$ 方向（特征值 $1 - \beta$）：记忆状态会保留 $1 - \beta$ 比例的历史信息，同时基于误差更新 $\beta$ 比例的新信息；</p></li><li><p>正交方向（特征值 1）：记忆状态完全保留，不发生任何更新或衰减。</p></li></ul><p>这一特性是 DeltaNet 实现 “精准记忆修正” 的核心 —— 仅修改与当前键相关的记忆，不干扰无关记忆。</p><h2 id="四、实例验证（直观理解）"><a href="#四、实例验证（直观理解）" class="headerlink" title="四、实例验证（直观理解）"></a>四、实例验证（直观理解）</h2><p>通过具体数值案例验证上述结论，让特性更易感知：</p><h3 id="假设条件"><a href="#假设条件" class="headerlink" title="假设条件"></a>假设条件</h3><ul><li><p>维度 $d=2$，$k$ 为 2 维 L2 归一化向量：$k = \begin{bmatrix} 1/\sqrt{2} \ 1/\sqrt{2} \end{bmatrix}$；</p></li><li><p>常数 $\beta=0.5$（满足 $0 &lt; \beta &lt; 1$）。</p></li></ul><h3 id="计算过程"><a href="#计算过程" class="headerlink" title="计算过程"></a>计算过程</h3><ol><li><p>计算外积矩阵 $k k^T$：</p><p>$k k^T = \begin{bmatrix} 1/\sqrt{2} \ 1/\sqrt{2} \end{bmatrix} \cdot \begin{bmatrix} 1/\sqrt{2} &amp; 1/\sqrt{2} \end{bmatrix} = \begin{bmatrix} 1/2 &amp; 1/2 \ 1/2 &amp; 1/2 \end{bmatrix}$</p></li><li><p>计算目标矩阵 $I - \beta k k^T$：</p><p>$I - 0.5 \cdot k k^T = \begin{bmatrix} 1 &amp; 0 \ 0 &amp; 1 \end{bmatrix} - 0.5 \cdot \begin{bmatrix} 1/2 &amp; 1/2 \ 1/2 &amp; 1/2 \end{bmatrix} = \begin{bmatrix} 3/4 &amp; -1/4 \ -1/4 &amp; 3/4 \end{bmatrix}$</p></li><li><p>求解特征值</p><p>通过特征方程 $\det(A - \lambda I) = 0$ 计算：</p><p>$\det\left( \begin{bmatrix} 3/4 - \lambda &amp; -1/4 \ -1/4 &amp; 3/4 - \lambda \end{bmatrix} \right) = (3/4 - \lambda)^2 - (1/4)^2 = 0$</p><p>解得：$\lambda_1 = 1$，$\lambda_2 = 0.5 = 1 - 0.5$，与推导结论完全一致。</p></li></ol><h2 id="五、DeltaNet-语境下的实际意义"><a href="#五、DeltaNet-语境下的实际意义" class="headerlink" title="五、DeltaNet 语境下的实际意义"></a>五、DeltaNet 语境下的实际意义</h2><p>该矩阵的特征值特性直接服务于 DeltaNet 的核心目标 —— 高效、精准的记忆更新，具体体现为：</p><h3 id="1-保证记忆更新的稳定性"><a href="#1-保证记忆更新的稳定性" class="headerlink" title="1. 保证记忆更新的稳定性"></a>1. 保证记忆更新的稳定性</h3><p>所有特征值落在 $(0,1]$ 区间，使得记忆状态 $S_t$ 的更新过程不会出现数值膨胀（特征值≤1），也不会出现信息丢失（特征值 &gt; 0），确保超长序列建模时的数值稳定性。</p><h3 id="2-实现精准的定向记忆修正"><a href="#2-实现精准的定向记忆修正" class="headerlink" title="2. 实现精准的定向记忆修正"></a>2. 实现精准的定向记忆修正</h3><p>仅在当前键 $k$ 的方向上进行记忆更新（特征值 $1 - \beta$），正交方向无变化，避免了传统线性注意力 “无差别积累” 导致的旧信息干扰，让 DeltaNet 能精准修正与当前键相关的记忆。</p><h3 id="3-兼顾效率与性能"><a href="#3-兼顾效率与性能" class="headerlink" title="3. 兼顾效率与性能"></a>3. 兼顾效率与性能</h3><p>特征值结构极简（仅两种取值），使得 $I - \beta k k^T$ 与记忆状态 $S_{t-1}$ 的乘法运算可简化为高效的向量操作，配合 DeltaNet 的线性复杂度设计，适配超长序列场景。</p><h2 id="六、核心结论"><a href="#六、核心结论" class="headerlink" title="六、核心结论"></a>六、核心结论</h2><p>$I - \beta k k^T$（$k$ L2 归一化、$0 beta 的特征值特性可归纳为 3 点：</p><ol><li><p>取值：仅两种情况 ——1 个 $1 - \beta$ 和 $d-1$ 个 1；</p></li><li><p>范围：所有特征值 ∈ $(0,1]$，矩阵正定且非膨胀；</p></li><li><p>意义：定向更新当前键相关记忆，保证 DeltaNet 的记忆精准性与稳定性。</p></li></ol><p>这一矩阵是 DeltaNet 区别于传统线性注意力的关键结构之一，其特征值特性直接支撑了算法 “高效长序列建模 + 精准上下文检索” 的核心优势。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ToyDL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> Delta Rule </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>轻量化设计之深度卷积和结构重参数</title>
      <link href="/2025/05/09/250509-reparam-depthwise-conv/"/>
      <url>/2025/05/09/250509-reparam-depthwise-conv/</url>
      
        <content type="html"><![CDATA[<div class="markmap-container" style="height:400px">  <svg data="{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;标准卷积&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;深度卷积&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;结构重参数&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;卷积-BN融合&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;并行卷积融合&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[6,7]},&quot;v&quot;:&quot;串行卷积融合&quot;}]}],&quot;p&quot;:{}}"></svg></div><blockquote><p>脑图可拖动和放缩</p></blockquote><blockquote><p>在深度学习领域，卷积神经网络（CNN）一直是计算机视觉任务的主流架构。近年来，随着对模型效率要求的提高，各种卷积变体和优化技术层出不穷。本文将深入探讨标准卷积、深度卷积以及结构重参数化技术，特别是其中的卷积-BN融合、并行卷积融合和串行卷积融合技术。</p><p><a href="https://github.com/Achhhe/ToyDL/tree/main/240706-rnn-implement">Github地址</a></p></blockquote><h3 id="标准卷积和深度卷积（DWConv）"><a href="#标准卷积和深度卷积（DWConv）" class="headerlink" title="标准卷积和深度卷积（DWConv）"></a>标准卷积和深度卷积（DWConv）</h3><p>标准卷积和深度卷积不做过多介绍，示意图如下</p><img src="/2025/05/09/250509-reparam-depthwise-conv/fig2-standard-vs-depthwise.jpeg" class="" title="标准卷积vs深度卷积"><h3 id="结构重参数（Structural-Re-parameterization）"><a href="#结构重参数（Structural-Re-parameterization）" class="headerlink" title="结构重参数（Structural Re-parameterization）"></a>结构重参数（Structural Re-parameterization）</h3><p>结构重参数化（Structural Re-parameterization）是一种训练-推理解耦的技术，在训练时使用复杂的结构，在推理时转换为简单的结构，既保证了训练时的性能，又提高了推理效率。</p><p>经典论文是<a href="https://github.com/DingXiaoH/RepVGG">CVPR2021 RepVGG</a>提出的并行重参数结构，示意图如下</p><img src="/2025/05/09/250509-reparam-depthwise-conv/fig1-repvgg-reparam.png" class="" title="RepVGG示意图"><p>训练阶段，每个block包括$3\times3$，$1\times1$和一个恒等映射，按照论文结论，BN的引入可以增加模型训练时候的拟合能力</p><p>测试阶段，串行的BN和卷积可以合并，并行的不同卷积可以统一合并成$3\times3$的标准卷积</p><p>对于测试来说，结构重参数是一种“<strong>免费的午餐</strong>”，可以无损提升模型性能【<a href="https://zhuanlan.zhihu.com/p/361090497">丁博士知乎解答</a>】</p><h4 id="卷积-BN融合"><a href="#卷积-BN融合" class="headerlink" title="卷积-BN融合"></a>卷积-BN融合</h4><p>将卷积层和后续的BN层融合为一个卷积层，减少推理时的计算量。</p><h5 id="融合原理"><a href="#融合原理" class="headerlink" title="融合原理"></a>融合原理</h5><p>BN层的计算：</p><p>$$y_{bn} = \gamma \cdot \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}} + \beta$$</p><p>融合后的卷积权重和偏置：<br>$$W_{fused} = \gamma \cdot W / \sqrt{\sigma^2 + \epsilon}$$<br>$$b_{fused} = \gamma \cdot (b - \mu) / \sqrt{\sigma^2 + \epsilon} + \beta$$</p><h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fuse_conv_bn</span><span class="token punctuation">(</span>conv<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">:</span>    w <span class="token operator">=</span> conv<span class="token punctuation">.</span>weight    b <span class="token operator">=</span> conv<span class="token punctuation">.</span>bias <span class="token keyword">if</span> conv<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>w<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>w<span class="token punctuation">.</span>device<span class="token punctuation">)</span>        gamma<span class="token punctuation">,</span> beta <span class="token operator">=</span> bn<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> bn<span class="token punctuation">.</span>bias    mean<span class="token punctuation">,</span> var <span class="token operator">=</span> bn<span class="token punctuation">.</span>running_mean<span class="token punctuation">,</span> bn<span class="token punctuation">.</span>running_var    std <span class="token operator">=</span> <span class="token punctuation">(</span>var <span class="token operator">+</span> bn<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 融合公式推导</span>    w_fused <span class="token operator">=</span> w <span class="token operator">*</span> <span class="token punctuation">(</span>gamma <span class="token operator">/</span> std<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    b_fused <span class="token operator">=</span> beta <span class="token operator">+</span> <span class="token punctuation">(</span>gamma <span class="token operator">/</span> std<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> mean<span class="token punctuation">)</span>        <span class="token keyword">return</span> w_fused<span class="token punctuation">,</span> b_fused  <span class="token comment"># 验证融合前后等价</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>conv<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>bn<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token comment"># 直接前馈</span>y <span class="token operator">=</span> bn<span class="token punctuation">(</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 融合前馈</span>w_fused<span class="token punctuation">,</span> b_fused <span class="token operator">=</span> fuse_conv_bn<span class="token punctuation">(</span>conv<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>conv_fused <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>conv_fused<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> conv_fused<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> w_fused<span class="token punctuation">,</span> b_fusedy_fused <span class="token operator">=</span> conv_fused<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'卷积BN融合最大误差：'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token operator">-</span>y_fused<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#接近0，1e-7量级 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="并行卷积融合"><a href="#并行卷积融合" class="headerlink" title="并行卷积融合"></a>并行卷积融合</h4><p>将多个并行分支的卷积融合为一个卷积。</p><h5 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h5><p>多个卷积核可以相加合并：<br>$$W_{fused} = \sum_i W_i$$<br>$$b_{fused} = \sum_i b_i$$</p><blockquote><p>公式中默认卷积核尺寸相同，不同则需padding至相同尺寸</p></blockquote><h5 id="示例代码（RepVGG结构：conv1-conv3-identity）"><a href="#示例代码（RepVGG结构：conv1-conv3-identity）" class="headerlink" title="示例代码（RepVGG结构：conv1 + conv3 + identity）"></a>示例代码（RepVGG结构：conv1 + conv3 + identity）</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 创建恒等映射核</span><span class="token keyword">def</span> <span class="token function">get_identity_kernel_groupwise</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">:</span>    per_group <span class="token operator">=</span> channels <span class="token operator">//</span> groups    <span class="token comment"># 支持分组卷积，组内进行标准卷积</span>    weight <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span> per_group<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> g <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>groups<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>per_group<span class="token punctuation">)</span><span class="token punctuation">:</span>            weight<span class="token punctuation">[</span>g<span class="token operator">*</span>per_group<span class="token operator">+</span>i<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>    <span class="token keyword">return</span> weight<span class="token comment"># 1x1卷积核扩展为3x3</span><span class="token keyword">def</span> <span class="token function">pad_1x1_to_3x3_groupwise</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> F<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> w<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">and</span> w<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">else</span> wC<span class="token punctuation">,</span> groups <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span>   <span class="token comment"># 通道数，分组数</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>C<span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>C<span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token comment"># 直接前馈</span>y <span class="token operator">=</span> conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> conv3<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token comment"># 融合前馈</span>w3<span class="token punctuation">,</span> b3 <span class="token operator">=</span> conv3<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> conv3<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>dataw1<span class="token punctuation">,</span> b1 <span class="token operator">=</span> pad_1x1_to_3x3_groupwise<span class="token punctuation">(</span>conv1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> conv1<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>dataw_id <span class="token operator">=</span> pad_1x1_to_3x3_groupwise<span class="token punctuation">(</span>get_identity_kernel_groupwise<span class="token punctuation">(</span>C<span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">)</span>b_id <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>C<span class="token punctuation">)</span>w_fused <span class="token operator">=</span> w3 <span class="token operator">+</span> w1 <span class="token operator">+</span> w_idb_fused <span class="token operator">=</span> b3 <span class="token operator">+</span> b1 <span class="token operator">+</span> b_idconv_fused <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>C<span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">)</span>conv_fused<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> conv_fused<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> w_fused<span class="token punctuation">,</span> b_fusedy_fused <span class="token operator">=</span> conv_fused<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'并行卷积融合最大误差：'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token operator">-</span>y_fused<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#接近0，1e-7量级 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="串行卷积融合"><a href="#串行卷积融合" class="headerlink" title="串行卷积融合"></a>串行卷积融合</h4><p>将多个连续的卷积层融合为一个等效的卷积层。</p><h5 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h5><p>两个卷积核的串行相当于它们的卷积核进行卷积：<br>$$W_{fused} = W_2 * W_1$$<br>$$b_{fused} = W_2 * b_1 + b_2$$</p><p>其中 $*$ 表示卷积操作。</p><blockquote><p>卷积时需要注意尺寸匹配，以及padding可能影响边界数值</p></blockquote><h5 id="示例代码（conv1升维-conv3特征提取-conv1降维）"><a href="#示例代码（conv1升维-conv3特征提取-conv1降维）" class="headerlink" title="示例代码（conv1升维-conv3特征提取-conv1降维）"></a>示例代码（conv1升维-conv3特征提取-conv1降维）</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fuse_serial_3layer_groups</span><span class="token punctuation">(</span>w1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> w3<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">:</span>    in_per_group <span class="token operator">=</span> w1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> groups    mid_per_group <span class="token operator">=</span> w2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> groups    out_per_group <span class="token operator">=</span> w3<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> groups        ws<span class="token punctuation">,</span> bs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># 支持分组卷积，组内进行标准卷积</span>    <span class="token keyword">for</span> g <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>groups<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 获取当前组的权重切片</span>        w1g <span class="token operator">=</span> w1<span class="token punctuation">[</span>g<span class="token operator">*</span>in_per_group<span class="token punctuation">:</span> <span class="token punctuation">(</span>g<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>in_per_group<span class="token punctuation">]</span>        b1g <span class="token operator">=</span> b1<span class="token punctuation">[</span>g<span class="token operator">*</span>in_per_group<span class="token punctuation">:</span> <span class="token punctuation">(</span>g<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>in_per_group<span class="token punctuation">]</span> <span class="token keyword">if</span> b1 <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span>        w2g <span class="token operator">=</span> w2<span class="token punctuation">[</span>g<span class="token operator">*</span>mid_per_group<span class="token punctuation">:</span> <span class="token punctuation">(</span>g<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>mid_per_group<span class="token punctuation">]</span>        b2g <span class="token operator">=</span> b2<span class="token punctuation">[</span>g<span class="token operator">*</span>mid_per_group<span class="token punctuation">:</span> <span class="token punctuation">(</span>g<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>mid_per_group<span class="token punctuation">]</span> <span class="token keyword">if</span> b2 <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span>        w3g <span class="token operator">=</span> w3<span class="token punctuation">[</span>g<span class="token operator">*</span>out_per_group<span class="token punctuation">:</span> <span class="token punctuation">(</span>g<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>out_per_group<span class="token punctuation">]</span>        b3g <span class="token operator">=</span> b3<span class="token punctuation">[</span>g<span class="token operator">*</span>out_per_group<span class="token punctuation">:</span> <span class="token punctuation">(</span>g<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>out_per_group<span class="token punctuation">]</span> <span class="token keyword">if</span> b3 <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span>                <span class="token comment"># 第一步：融合conv1和conv2</span>        <span class="token comment"># w1(1x1)作为卷积核避免padding</span>        w12 <span class="token operator">=</span> F<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>w2g<span class="token punctuation">,</span> w1g<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>          b12 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w2g <span class="token operator">*</span> b1g<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> b1g <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b2g <span class="token keyword">if</span> b2g <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token comment"># 第二步：融合conv12和conv3</span>        <span class="token comment"># w3(1x1)作为卷积核避免padding</span>        w123 <span class="token operator">=</span> F<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>w12<span class="token punctuation">.</span>flip<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> w3g<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flip<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>        b123 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w3g <span class="token operator">*</span> b12<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b12<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b3g <span class="token keyword">if</span> b3g <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span>                ws<span class="token punctuation">.</span>append<span class="token punctuation">(</span>w123<span class="token punctuation">)</span>        bs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b123<span class="token punctuation">)</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>ws<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  C<span class="token punctuation">,</span> groups<span class="token punctuation">,</span> gain <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span>  conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>C<span class="token punctuation">,</span> gain<span class="token operator">*</span>C<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>gain<span class="token operator">*</span>C<span class="token punctuation">,</span> gain<span class="token operator">*</span>C<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>   <span class="token comment">#高维提取特征</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>gain<span class="token operator">*</span>C<span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token comment"># 直接前馈</span>y <span class="token operator">=</span> conv3<span class="token punctuation">(</span>conv2<span class="token punctuation">(</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 融合前馈</span>w1<span class="token punctuation">,</span> b1 <span class="token operator">=</span> conv1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> conv1<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>dataw2<span class="token punctuation">,</span> b2 <span class="token operator">=</span> conv2<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> conv2<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>dataw3<span class="token punctuation">,</span> b3 <span class="token operator">=</span> conv3<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> conv3<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>dataw_fused<span class="token punctuation">,</span> b_fused <span class="token operator">=</span> fuse_serial_3layer_groups<span class="token punctuation">(</span>w1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> w2<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> w3<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> groups<span class="token punctuation">)</span>conv_fused <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>C<span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">)</span>conv_fused<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> conv_fused<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> w_fused<span class="token punctuation">,</span> b_fusedy_fused <span class="token operator">=</span> conv_fused<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'串行卷积融合最大误差：'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token operator">-</span>y_fused<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 避免边界padding影响</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ToyDL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Lightweight </tag>
            
            <tag> Reparam </tag>
            
            <tag> Depthwise conv </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ToyDL之扩散模型DDPM</title>
      <link href="/2024/08/24/240824-toy-diffusion/"/>
      <url>/2024/08/24/240824-toy-diffusion/</url>
      
        <content type="html"><![CDATA[<blockquote><p>背景：某生成任务用到了DDPM，为了更直观理解其前向和反向过程，写个简易的Toy工程</p><p><a href="https://github.com/Achhhe/ToyDL/tree/main/240824-toy-diffusion">Github地址</a></p></blockquote><h2 id="扩散模型简介"><a href="#扩散模型简介" class="headerlink" title="扩散模型简介"></a>扩散模型简介</h2><p>由两条参数化<strong>马尔可夫链</strong>组成。 前向过程（又称扩散过程）时逐渐向数据中添加噪声，直到数据完全退化为噪声。反向过程则逐步去噪，最终达到数据生成的目的</p><p>下两图是毕设中的，条件扩散模型</p><img src="/2024/08/24/240824-toy-diffusion/chp4-diffusion-model-intro2.png" class=""><img src="/2024/08/24/240824-toy-diffusion/chp4-ieddpm-framework-visio.png" class=""><h2 id="前向过程"><a href="#前向过程" class="headerlink" title="前向过程"></a>前向过程</h2><p>前向为加噪过程，核心公式如下</p><img src="/2024/08/24/240824-toy-diffusion/core-eq-diffusion.png" class=""><p>其中$\bar{\alpha}_t=\textstyle \prod_1^t\alpha_t$</p><p>$\alpha_{1:T}\triangleq(\alpha_1,\alpha2,\dots,\alpha_T)$是一组超参数，用以控制每次迭代的噪声方差，并且满足条件$0 &lt; \alpha_t &lt; 1$以确保$t \rightarrow \infty$时方差有界</p><p>对应核心代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">sqrt_alphas_cumprod <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>alphas_cumprod<span class="token punctuation">)</span>sqrt_one_minus_alphas_cumprod <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> alphas_cumprod <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token comment"># sample t and noise</span>t <span class="token operator">=</span> torch<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n_steps<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>z <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token comment"># forward sample xt</span>xt <span class="token operator">=</span> sqrt_alphas_cumprod<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> x <span class="token operator">+</span> sqrt_one_minus_alphas_cumprod<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> z<span class="token comment"># denoise</span>z_pred <span class="token operator">=</span> denoiser<span class="token punctuation">(</span>xt<span class="token punctuation">,</span> t<span class="token punctuation">)</span>loss <span class="token operator">=</span> F<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>z<span class="token punctuation">,</span> z_pred<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="反向过程"><a href="#反向过程" class="headerlink" title="反向过程"></a>反向过程</h2><p>反向采样过程的核心公式如下</p><img src="/2024/08/24/240824-toy-diffusion/core-eq-final.png" class=""><p>对应核心代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">alphas_cumprod_prev <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> alphas_cumprod<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>posterior_variance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> alphas<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> alphas_cumprod_prev<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> alphas_cumprod<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">sample_ddpm</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">:</span>    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>    at <span class="token operator">=</span> alphas<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    st <span class="token operator">=</span> sqrt_one_minus_alphas_cumprod<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    mean <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> at<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> at<span class="token punctuation">)</span> <span class="token operator">*</span> model<span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>n_samples<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> st<span class="token punctuation">)</span>    var <span class="token operator">=</span> posterior_variance<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    xt_pre <span class="token operator">=</span> mean <span class="token operator">+</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>var<span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>n_samples<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> xt_pre<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：反向过程需要计算给定$\boldsymbol{x}_0$下的后验分布</p><img src="/2024/08/24/240824-toy-diffusion/core-eq-reverse.png" class=""><p>然而反向过程$\boldsymbol{x}_0$未知，DDPM采用的是网络去噪估计$\hat{\boldsymbol{x}}_0=\frac{1}{\sqrt{\bar{\alpha}_t}}(\boldsymbol{x}_t-\sqrt{1-\bar{\alpha}_t}\epsilon_\theta)$，带入上式即可得到反向核心公式</p></blockquote><h2 id="DDIM加速采样"><a href="#DDIM加速采样" class="headerlink" title="DDIM加速采样"></a>DDIM加速采样</h2><img src="/2024/08/24/240824-toy-diffusion/core-eq-final-ddim.png" class=""><p>对应核心公式</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">sample_ddim</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">,</span> eta <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>    at <span class="token operator">=</span> alphas_cumprod<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    at_1 <span class="token operator">=</span> alphas_cumprod_prev<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    sigma_t <span class="token operator">=</span> eta <span class="token operator">*</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> at_1<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> at<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> at <span class="token operator">/</span> at_1<span class="token punctuation">)</span><span class="token punctuation">)</span>    xt_pre <span class="token operator">=</span> <span class="token punctuation">(</span>        torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>at_1 <span class="token operator">/</span> at<span class="token punctuation">)</span> <span class="token operator">*</span> x         <span class="token operator">+</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> at_1 <span class="token operator">-</span> sigma_t <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>            <span class="token punctuation">(</span>at_1 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> at<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> at<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> model<span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>n_samples<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">+</span> sigma_t <span class="token operator">*</span> torch<span class="token punctuation">.</span>randn_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> xt_pre<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实验对比"><a href="#实验对比" class="headerlink" title="实验对比"></a>实验对比</h2><p>以一维数据为例，扩散模型学习给定噪声分布，完成后分别基于DDPM和DDIM进行生成</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">data <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>    torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span>    torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">40000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.03</span> <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">,</span>    torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01</span> <span class="token operator">-</span> <span class="token number">0.4</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果如下</p><img src="/2024/08/24/240824-toy-diffusion/hist-comp.png" class=""><p>可以看出，扩散模型基本可以学出目标数据分布。DDIM可能是由于模型太简单，加速不明显，一般可以10~20倍加速</p><h2 id="问答环节"><a href="#问答环节" class="headerlink" title="问答环节"></a>问答环节</h2><ul><li>DDPM为什么慢？<ul><li>答：因为需要T比较大</li></ul></li><li>DDPM为什么需要T比较大，能不能缩短步数，或者跳步采样？<ul><li>答：</li></ul></li><li>DDIM为什么能加速？<ul><li>答：</li></ul></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://space.bilibili.com/13355688?spm_id_from=333.976.0.0">Yuki大佬的扩散模型详解</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ToyDL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pytorch </tag>
            
            <tag> 扩散模型 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ToyDL之Pytorch中RNN的内部实现</title>
      <link href="/2024/07/06/240706-pytorchrnn-implement/"/>
      <url>/2024/07/06/240706-pytorchrnn-implement/</url>
      
        <content type="html"><![CDATA[<blockquote><p>背景：某分类任务用到了两层（单向）RNN，训练时基于Pytorch中nn.RNN()，C化部署时则需要自己手动实现</p><p><a href="https://github.com/Achhhe/ToyDL/tree/main/240706-rnn-implement">Github地址</a></p></blockquote><h3 id="RNN"><a href="#RNN" class="headerlink" title="RNN"></a>RNN</h3><p>Pytorch中<a href="https://pytorch.org/docs/stable/generated/torch.nn.RNN.html">RNN</a>迭代公式如下</p><img src="/2024/07/06/240706-pytorchrnn-implement/rnn.png" class=""><p>$x_t$为输入，$h_{t-1}$为隐变量</p><p>可以看出$h_t$其实就是$x_t$和$h_{t-1}$分别经过线性层，因此可以用两个nn.Linear()实现</p><p>以2层单向RNN为例，基于pytorch的rnn分类器以及自我实现如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RnnClassifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">,</span> n_layer <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>RnnClassifier<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>rnn <span class="token operator">=</span> nn<span class="token punctuation">.</span>RNN<span class="token punctuation">(</span>input_size <span class="token operator">=</span> in_c<span class="token punctuation">,</span> hidden_size <span class="token operator">=</span> hid_c<span class="token punctuation">,</span> num_layers <span class="token operator">=</span> n_layer<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> hn <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">''' x: (T,B,in_c)        hn: (2,B,hid_c)        '''</span>         x<span class="token punctuation">,</span> hn <span class="token operator">=</span> self<span class="token punctuation">.</span>rnn<span class="token punctuation">(</span>x<span class="token punctuation">,</span> hn<span class="token punctuation">)</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> x<span class="token punctuation">,</span> hn<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">MyRnnClassifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>MyRnnClassifier<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>hid_c <span class="token operator">=</span> hid_c        self<span class="token punctuation">.</span>Wih0 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Whh0 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Wih1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Whh1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>tanh <span class="token operator">=</span> nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> hn <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>            x <span class="token operator">=</span> x<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> hn <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            hn <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>hid_c<span class="token punctuation">,</span> dtype <span class="token operator">=</span> x<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device <span class="token operator">=</span> x<span class="token punctuation">.</span>device<span class="token punctuation">)</span>        <span class="token comment"># 2-layer rnn</span>        hn0 <span class="token operator">=</span> self<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Wih0<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>Whh0<span class="token punctuation">(</span>hn<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        hn1 <span class="token operator">=</span> self<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Wih1<span class="token punctuation">(</span>hn0<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>Whh1<span class="token punctuation">(</span>hn<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>hn1<span class="token punctuation">)</span>        hn <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>hn0<span class="token punctuation">,</span> hn1<span class="token punctuation">]</span><span class="token punctuation">,</span> dim <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> x<span class="token punctuation">,</span> hn    <span class="token keyword">def</span> <span class="token function">copy_params_rnn</span><span class="token punctuation">(</span>_from<span class="token punctuation">,</span> _to<span class="token punctuation">)</span><span class="token punctuation">:</span>    _dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> _from<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">'classifier'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> k<span class="token punctuation">:</span>            wei<span class="token punctuation">,</span> name<span class="token punctuation">,</span> num <span class="token operator">=</span> k<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span>            k_new <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'W</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>num<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>wei<span class="token punctuation">}</span></span><span class="token string">'</span></span>            _dict<span class="token punctuation">[</span>k_new<span class="token punctuation">]</span> <span class="token operator">=</span> v        <span class="token keyword">else</span><span class="token punctuation">:</span>            _dict<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v    _to<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>_dict<span class="token punctuation">)</span>    <span class="token keyword">return</span> _to<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>基于nn.RNN()进行模型训练，完成后将pth文件中的权重字典转成基于nn.Linear()的自我实现形式，可以验证输出严格对齐</p></blockquote><h3 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h3><p>与RNN类似，<a href="https://pytorch.org/docs/stable/generated/torch.nn.LSTM.html#torch.nn.LSTM">LSTM</a>也可以自我实现，公式如下</p><img src="/2024/07/06/240706-pytorchrnn-implement/lstm.png" class=""><p>LSTM比RNN多几个gate，因此单层LSTM的自我实现需要用到8个nn.Linear()</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">LstmClassifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">,</span> n_layer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>LstmClassifier<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_size <span class="token operator">=</span> in_c<span class="token punctuation">,</span> hidden_size <span class="token operator">=</span> hid_c<span class="token punctuation">,</span> num_layers <span class="token operator">=</span> n_layer<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> hn <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">''' x: (T,B,in_c)        hn: (2,B,hid_c)        '''</span>         x<span class="token punctuation">,</span> hn <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>x<span class="token punctuation">,</span> hn<span class="token punctuation">)</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> x<span class="token punctuation">,</span> hn<span class="token keyword">class</span> <span class="token class-name">MyLstmClassifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>MyLstmClassifier<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>hid_c <span class="token operator">=</span> hid_c        self<span class="token punctuation">.</span>Wii <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Wif <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Wig <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Wio <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Whi <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Whf <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Whg <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>Who <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> hid_c<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hid_c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>sigmoid <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>tanh <span class="token operator">=</span> nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> state <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>            x <span class="token operator">=</span> x<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> state <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            ht <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>hid_c<span class="token punctuation">,</span> dtype <span class="token operator">=</span> x<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device <span class="token operator">=</span> x<span class="token punctuation">.</span>device<span class="token punctuation">)</span>            ct <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>hid_c<span class="token punctuation">,</span> dtype <span class="token operator">=</span> x<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device <span class="token operator">=</span> x<span class="token punctuation">.</span>device<span class="token punctuation">)</span>            state <span class="token operator">=</span> <span class="token punctuation">(</span>ht<span class="token punctuation">,</span> ct<span class="token punctuation">)</span>        ht<span class="token punctuation">,</span> ct <span class="token operator">=</span> state        <span class="token comment"># lstm</span>        it <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Wii<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>Whi<span class="token punctuation">(</span>ht<span class="token punctuation">)</span><span class="token punctuation">)</span>        ft <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Wif<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>Whf<span class="token punctuation">(</span>ht<span class="token punctuation">)</span><span class="token punctuation">)</span>        gt <span class="token operator">=</span> self<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Wig<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>Whg<span class="token punctuation">(</span>ht<span class="token punctuation">)</span><span class="token punctuation">)</span>        ot <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Wio<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>Who<span class="token punctuation">(</span>ht<span class="token punctuation">)</span><span class="token punctuation">)</span>        ct <span class="token operator">=</span> ft <span class="token operator">*</span> ct <span class="token operator">+</span> it <span class="token operator">*</span> gt        ht <span class="token operator">=</span> ot <span class="token operator">*</span> self<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>ct<span class="token punctuation">)</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>ht<span class="token punctuation">)</span>        <span class="token keyword">return</span> x<span class="token punctuation">,</span> <span class="token punctuation">(</span>ht<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">copy_params_lstm</span><span class="token punctuation">(</span>_from<span class="token punctuation">,</span> _to<span class="token punctuation">)</span><span class="token punctuation">:</span>    _dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> _from<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">'_ih_'</span> <span class="token keyword">in</span> k <span class="token keyword">or</span> <span class="token string">'_hh_'</span> <span class="token keyword">in</span> k<span class="token punctuation">:</span>            hid_each <span class="token operator">=</span> v<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">4</span>            wei<span class="token punctuation">,</span> name<span class="token punctuation">,</span> _ <span class="token operator">=</span> k<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span>            <span class="token comment"># lstm的权重存在一起</span>            _dict<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'W</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">i.</span><span class="token interpolation"><span class="token punctuation">{</span>wei<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token punctuation">:</span>hid_each<span class="token punctuation">]</span>            _dict<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'W</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">f.</span><span class="token interpolation"><span class="token punctuation">{</span>wei<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span>hid_each <span class="token punctuation">:</span> hid_each<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span>            _dict<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'W</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">g.</span><span class="token interpolation"><span class="token punctuation">{</span>wei<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span>hid_each <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">:</span> hid_each <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span>            _dict<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'W</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">o.</span><span class="token interpolation"><span class="token punctuation">{</span>wei<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span>hid_each <span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            _dict<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v    _to<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>_dict<span class="token punctuation">)</span>    <span class="token keyword">return</span> _to<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>   <span class="token comment"># (T,B,in_c)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'------------ testing rnn ------------'</span><span class="token punctuation">)</span>    Rnn <span class="token operator">=</span> RnnClassifier<span class="token punctuation">(</span>in_c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> hid_c <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span>    MyRnn <span class="token operator">=</span> MyRnnClassifier<span class="token punctuation">(</span>in_c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> hid_c <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span>    MyRnn <span class="token operator">=</span> copy_params_rnn<span class="token punctuation">(</span>Rnn<span class="token punctuation">,</span> MyRnn<span class="token punctuation">)</span>    y1<span class="token punctuation">,</span> state1 <span class="token operator">=</span> Rnn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    y2<span class="token punctuation">,</span> state2 <span class="token operator">=</span> MyRnn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>y1 <span class="token operator">==</span> y2<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>state1<span class="token punctuation">,</span> state2<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'------------ testing lstm ------------'</span><span class="token punctuation">)</span>    Rnn <span class="token operator">=</span> LstmClassifier<span class="token punctuation">(</span>in_c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> hid_c <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span>    MyRnn <span class="token operator">=</span> MyLstmClassifier<span class="token punctuation">(</span>in_c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> hid_c <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span>    MyRnn <span class="token operator">=</span> copy_params_lstm<span class="token punctuation">(</span>Rnn<span class="token punctuation">,</span> MyRnn<span class="token punctuation">)</span>    y1<span class="token punctuation">,</span> state1 <span class="token operator">=</span> Rnn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    y2<span class="token punctuation">,</span> state2 <span class="token operator">=</span> MyRnn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>y1 <span class="token operator">==</span> y2<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>state1<span class="token punctuation">,</span> state2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出结果严格对齐</p><img src="/2024/07/06/240706-pytorchrnn-implement/test.png" class=""><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://pytorch.org/docs/stable/generated/torch.nn.RNN.html">官方RNN文档</a></p><p><a href="https://pytorch.org/docs/stable/generated/torch.nn.LSTM.html#torch.nn.LSTM">官方LSTM文档</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> ToyDL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pytorch </tag>
            
            <tag> RNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo+matery博客搭建之插入PDF</title>
      <link href="/2024/07/06/240706-insert-pdf-in-hexo/"/>
      <url>/2024/07/06/240706-insert-pdf-in-hexo/</url>
      
        <content type="html"><![CDATA[<h3 id="hexo-pdf插件安装"><a href="#hexo-pdf插件安装" class="headerlink" title="hexo-pdf插件安装"></a>hexo-pdf插件安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> hexo-pdf <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="文章插入"><a href="#文章插入" class="headerlink" title="文章插入"></a>文章插入</h3><p>最简单的就是</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% pdf url %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>优点：简单方便<br>缺点：无法调整大小</p><p>url可以是相对路径或者网络链接</p></blockquote><div class="row">    <embed src="理解SVM的三层境界.pdf" width="100%" height="550" type="application/pdf"></div><p>也可用下面命令</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>embed</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>理解SVM的三层境界.pdf<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>750<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://github.com/superalsrk/hexo-pdf/">hexo-pdf</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo+matery博客搭建之访问加速</title>
      <link href="/2024/07/06/240706-blog-accelerator/"/>
      <url>/2024/07/06/240706-blog-accelerator/</url>
      
        <content type="html"><![CDATA[<h3 id="代码压缩优化"><a href="#代码压缩优化" class="headerlink" title="代码压缩优化"></a>代码压缩优化</h3><h4 id="hexo-neat插件"><a href="#hexo-neat插件" class="headerlink" title="hexo-neat插件"></a>hexo-neat插件</h4><p>根目录安装插件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-neat <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将以下配置添加至站点配置文件<code>_config.yaml</code>末尾</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#hexo-neat 优化提速插件（去掉HTML、css、js的blank字符）</span>neat_enable: <span class="token boolean">true</span>neat_html:  enable: <span class="token boolean">true</span>  exclude:    - <span class="token string">'**/*.md'</span>   <span class="token comment">#避免markdown 语法的代码块消失</span>neat_css:  enable: <span class="token boolean">true</span>  exclude:    - <span class="token string">'**/*.min.css'</span>neat_js:  enable: <span class="token boolean">true</span>  mangle: <span class="token boolean">true</span>  output:  compress:  exclude:    - <span class="token string">'**/*.min.js'</span>    - <span class="token string">'**/**/instantpage.js'</span>    - <span class="token string">'**/matery.js'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.sky03.cn/posts/42790.html#toc-heading-15">Hexo进阶之各种优化</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> 博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo+matery博客搭建之Github部署</title>
      <link href="/2024/07/03/hexo-github-deploy/"/>
      <url>/2024/07/03/hexo-github-deploy/</url>
      
        <content type="html"><![CDATA[<h3 id="SSH密钥链接"><a href="#SSH密钥链接" class="headerlink" title="SSH密钥链接"></a>SSH密钥链接</h3><p>打开Git Bash，配置邮箱和姓名</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name Achhhe<span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email <span class="token number">2238371421</span>@qq.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>生成密钥，将<code>id_rsa.pub</code>的内容复制粘贴到github账户的SSH Key中</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-C</span> <span class="token string">"2238371421@qq.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>测试是否免密链接成功，可以多试几次</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-T</span> git@github.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Github部署"><a href="#Github部署" class="headerlink" title="Github部署"></a>Github部署</h3><p>github账户新建一个<code>index.html</code>页面</p><p>修改站点配置文件<code>_config.yml</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">url: https://Achhhe.github.io/deploy:  type: <span class="token function">git</span>  <span class="token comment"># repo: https://github.com/Achhhe/Achhhe.github.io  # 半年多没更新blog，再hexo d需要填username，报错</span>  repo: git@github.com:Achhhe/Achhhe.github.io.git    <span class="token comment"># 试一下这个可以</span>  branch: master <span class="token comment">#要与index.html相同分支s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>安装部署插件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1</span><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git <span class="token parameter variable">--save</span><span class="token comment"># 或</span><span class="token comment"># 2 如果网不好可以用cnpm，cnpm安装方式可上网搜索</span>cnpm <span class="token function">install</span> hexo-deployer-git <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>部署至github</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo cleanhexo ghexo d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.csdn.net/victoryxa/article/details/103733655">SSH密钥链接</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> 博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
            <tag> Github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo+matery博客搭建之主题美化</title>
      <link href="/2024/07/01/blog-beautify/"/>
      <url>/2024/07/01/blog-beautify/</url>
      
        <content type="html"><![CDATA[<div class="markmap-container" style="height:400px">  <svg data="{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;下载node.js和git&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;hexo博客美化&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;美化：代码高亮，行号显示，搜索，字数统计，emoji，&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;todo：看板娘，暗黑模式，樱花特效，右键定制，时光列表，个人相册&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;配置修改：个人简介，运行时间，主题颜色，文章加密，个人相册等&quot;}]}],&quot;p&quot;:{}}"></svg></div><blockquote><p>脑图可拖动和放缩</p></blockquote><h3 id="定制化美化"><a href="#定制化美化" class="headerlink" title="定制化美化"></a>定制化美化</h3><h4 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h4><p>本人安装<code>hexo 7.2.0</code>，从 Hexo5.0 版本开始自带了 <code>prismjs</code> 代码语法高亮的支持</p><p>如果你的博客中曾经安装过 <code>hexo-prism-plugin</code> 的插件，那么你须要执行 <code>npm uninstall hexo-prism-plugin</code> 来卸载掉它，否则生成的代码中会有 <code>{</code> 和 <code>}</code> 的转义字符。</p><p>然后，修改 Hexo 根目录下 <code>_config.yml</code> 文件中 <code>highlight.enable</code> 的值为 <code>false</code>，并将 <code>prismjs.enable</code> 的值设置为 <code>true</code>，主要配置如下，修改 Hexo 根目录下 <code>_config.yml</code> 文件中 <code>highlight.enable</code> 的值为 <code>false</code>，并新增 <code>prism</code> 插件相关的配置，主要配置如下：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">syntax_highlighter</span><span class="token punctuation">:</span> prismjs<span class="token key atrule">highlight</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">auto_detect</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">wrap</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">hljs</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">prismjs</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">preprocess</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：需要将<code>syntax_highlighter</code>值置为<code>prismjs</code></p><h4 id="行号显示"><a href="#行号显示" class="headerlink" title="行号显示"></a>行号显示</h4><p>默认版本不显示行号，在主题<code>source/css/matery.css</code>添加</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.line-numbers-rows</span> <span class="token punctuation">{</span>    <span class="token property">border-right-width</span><span class="token punctuation">:</span> 0px <span class="token important">!important</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.line-numbers</span> <span class="token punctuation">{</span>    <span class="token property">padding</span><span class="token punctuation">:</span> 1.5rem 1.5rem 1.5rem 3.5rem <span class="token important">!important</span><span class="token punctuation">;</span>    <span class="token property">margin</span><span class="token punctuation">:</span> 1rem 0 <span class="token important">!important</span><span class="token punctuation">;</span>    <span class="token property">background</span><span class="token punctuation">:</span> #272822<span class="token punctuation">;</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>    <span class="token property">border-radius</span><span class="token punctuation">:</span> 0.35rem<span class="token punctuation">;</span>    <span class="token property">tab-size</span><span class="token punctuation">:</span> 4<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在主题下的<code>source/libs/prism/prism.css</code>添加</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">pre[class*="language-"].line-numbers</span> <span class="token punctuation">{</span> <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span> <span class="token property">padding-left</span><span class="token punctuation">:</span> 3.8em<span class="token punctuation">;</span> <span class="token property">counter-reset</span><span class="token punctuation">:</span> linenumber<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">pre[class*="language-"].line-numbers &gt; code</span> <span class="token punctuation">{</span> <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span> <span class="token property">white-space</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.line-numbers .line-numbers-rows</span> <span class="token punctuation">{</span> <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span> <span class="token property">pointer-events</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span> <span class="token property">left</span><span class="token punctuation">:</span> -3.8em<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 3em<span class="token punctuation">;</span> <span class="token comment">/* works for line-numbers below 1000 lines */</span> <span class="token property">letter-spacing</span><span class="token punctuation">:</span> -1px<span class="token punctuation">;</span> <span class="token property">border-right</span><span class="token punctuation">:</span> 1px solid #999<span class="token punctuation">;</span> <span class="token property">-webkit-user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">-moz-user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">-ms-user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token selector">.line-numbers-rows &gt; span</span> <span class="token punctuation">{</span>  <span class="token property">pointer-events</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>  <span class="token property">counter-increment</span><span class="token punctuation">:</span> linenumber<span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token selector">.line-numbers-rows &gt; span:before</span> <span class="token punctuation">{</span>   <span class="token property">content</span><span class="token punctuation">:</span> <span class="token function">counter</span><span class="token punctuation">(</span>linenumber<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token property">color</span><span class="token punctuation">:</span> #999<span class="token punctuation">;</span>   <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>   <span class="token property">padding-right</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span>   <span class="token property">text-align</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em>可以添加行号，但是竖线还是没显示，以后找机会学习下其他大佬的操作</em></p><h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><p>本主题中还使用到了 <a href="https://github.com/wzpan/hexo-generator-search">hexo-generator-search</a> 的 Hexo 插件来做内容搜索，安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-search <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">search</span><span class="token punctuation">:</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> search.xml  <span class="token key atrule">field</span><span class="token punctuation">:</span> post<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="中文链接转拼音（建议安装）"><a href="#中文链接转拼音（建议安装）" class="headerlink" title="中文链接转拼音（建议安装）"></a>中文链接转拼音（建议安装）</h4><p>如果你的文章名称是中文的，那么 Hexo 默认生成的永久链接也会有中文，这样不利于 <code>SEO</code>，且 <code>gitment</code> 评论对中文链接也不支持。我们可以用 <a href="https://github.com/viko16/hexo-permalink-pinyin">hexo-permalink-pinyin</a> Hexo 插件使在生成文章时生成中文拼音的永久链接。</p><p>安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo-permalink-pinyin <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">permalink_pinyin</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">separator</span><span class="token punctuation">:</span> <span class="token string">'-'</span> <span class="token comment"># default: '-'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="文章字数统计插件（建议安装）"><a href="#文章字数统计插件（建议安装）" class="headerlink" title="文章字数统计插件（建议安装）"></a>文章字数统计插件（建议安装）</h4><p>如果你想要在文章中显示文章字数、阅读时长信息，可以安装 <a href="https://github.com/willin/hexo-wordcount">hexo-wordcount</a>插件。</p><p>安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i <span class="token parameter variable">--save</span> hexo-wordcount<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后只需在本主题下的 <code>_config.yml</code> 文件中，将各个文章字数相关的配置激活即可：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">postInfo</span><span class="token punctuation">:</span>  <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 发布日期</span>  <span class="token key atrule">update</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 更新日期</span>  <span class="token key atrule">wordCount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 文章字数统计</span>  <span class="token key atrule">totalCount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 站点总文章字数</span>  <span class="token key atrule">min2read</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 文章阅读时长</span>  <span class="token key atrule">readCount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 文章阅读次数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="添加emoji表情支持（可选的）"><a href="#添加emoji表情支持（可选的）" class="headerlink" title="添加emoji表情支持（可选的）"></a>添加emoji表情支持（可选的）</h4><p>本主题新增了对<code>emoji</code>表情的支持，使用到了 <a href="https://npm.taobao.org/package/hexo-filter-github-emojis">hexo-filter-github-emojis</a> 的 Hexo 插件来支持 <code>emoji</code>表情的生成，把对应的<code>markdown emoji</code>语法（<code>::</code>,例如：<code>:smile:</code> <span class="github-emoji"><span>😄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>）转变成会跳跃的<code>emoji</code>表情，安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-filter-github-emojis <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p><pre class="line-numbers language-none"><code class="language-none">githubEmojis:  enable: true  className: github-emoji  inject: true  styles:  customEmojis:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行 <code>hexo clean &amp;&amp; hexo g</code> 重新生成博客文件，然后就可以在文章中对应位置看到你用<code>emoji</code>语法写的表情了</p><h4 id="看板娘"><a href="#看板娘" class="headerlink" title="看板娘"></a>看板娘</h4><p><a href="https://www.chensheng.group/2020/07/27/135-hexo%E7%9C%8B%E6%9D%BF%E5%A8%98/">参考</a></p><h4 id="暗黑模式"><a href="#暗黑模式" class="headerlink" title="暗黑模式"></a>暗黑模式</h4><p>参考<a href="https://blog.17lai.site/posts/4a2050e2/#%E6%B7%BB%E5%8A%A0%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E5%88%87%E6%8D%A2">夜法</a>大佬添加了深浅主题交换</p><p>修改<code>themes&gt;hexo-theme-matery&gt;source&gt;css&gt;matery.css</code>参数，调整位置</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.sum-moon-box</span> <span class="token punctuation">{</span>    <span class="token property">width</span><span class="token punctuation">:</span> 48px<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 48px<span class="token punctuation">;</span>    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>    <span class="token property">border-radius</span><span class="token punctuation">:</span> 10%<span class="token punctuation">;</span>    <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>    <span class="token property">right</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>    <span class="token property">bottom</span><span class="token punctuation">:</span> 135px<span class="token punctuation">;</span>     <span class="token comment">/*调整位置*/</span>    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>    <span class="token property">z-index</span><span class="token punctuation">:</span> 900<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>暂时可用，个人喜欢放在菜单导航栏，但是目前能力有限<span class="github-emoji"><span>😭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p></blockquote><p>原模板初始为浅色主题，但图标为太阳<code>fa-sun</code>，需要修改图标为月亮<code>fa-moon</code></p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sum-moon-box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn-floating btn-large waves-effect waves-light<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">switchNightMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>深浅主题切换<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sum-moon-icon<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-moon<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>48px<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span>48px<span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> 28px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="收缩目录按钮"><a href="#收缩目录按钮" class="headerlink" title="收缩目录按钮"></a>收缩目录按钮</h4><p>目录收缩按钮，在<code>/themes/hexo-theme-matery/layout/_partial/post-detail-toc.ejs</code>中</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* toc按钮位置调整 */</span><span class="token selector">#floating-toc-btn</span> <span class="token punctuation">{</span>    <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>    <span class="token property">right</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>    <span class="token property">bottom</span><span class="token punctuation">:</span> 135px<span class="token punctuation">;</span>     <span class="token comment">/*原来为75*/</span>    <span class="token property">padding-top</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>    <span class="token property">z-index</span><span class="token punctuation">:</span> 998<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="返回顶部按钮"><a href="#返回顶部按钮" class="headerlink" title="返回顶部按钮"></a>返回顶部按钮</h4><p>位置调整在<code>themes&gt;hexo-theme-matery&gt;source&gt;css&gt;matery.css</code>中</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/*回到顶部按钮样式*/</span><span class="token selector">.top-scroll</span> <span class="token punctuation">{</span>    <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>    <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>    <span class="token property">right</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>    <span class="token property">bottom</span><span class="token punctuation">:</span> 135px<span class="token punctuation">;</span>  <span class="token comment">/*原来为15*/</span>    <span class="token property">padding-top</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>    <span class="token property">z-index</span><span class="token punctuation">:</span> 998<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加”返回顶部”文字提示，在<code>themes\hexo-theme-matery\layout\_partial\back-top.ejs</code></p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>backTop<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>top-scroll<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn-floating btn-large waves-effect waves-light<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#!<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>返回顶部<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-arrow-up<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="导航栏添加深浅主题切换按钮"><a href="#导航栏添加深浅主题切换按钮" class="headerlink" title="导航栏添加深浅主题切换按钮"></a>导航栏添加深浅主题切换按钮</h4><p>将<code>themes/hexo-theme-matery/layout/_partial/day-night.ejs</code>中原主题切换按钮注释掉</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token comment">&lt;!-- &lt;div class="sum-moon-box"&gt;  &lt;a class="btn-floating btn-large waves-effect waves-light" onclick="switchNightMode()" title="深浅主题切换" &gt;    &lt;i id="sum-moon-icon" class="fas fa-moon" style="width:48px; height:48px; font-size: 28px;"&gt;&lt;/i&gt;  &lt;/a&gt;&lt;/div&gt; --&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在导航栏文件<code>themes/hexo-theme-matery/layout/_partial/navigation.ejs</code>中的搜索后面添加主题切换按钮，同时去掉原样式<code>btn-floating</code>和<code>btn-large</code>，调整大小</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#searchModal<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-trigger waves-effect waves-light<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>searchIcon<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-search<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">)</span> </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">zoom</span><span class="token punctuation">:</span> 0.85<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-trigger waves-effect waves-light<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">switchNightMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>深浅主题切换<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sum-moon-icon<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-moon<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">zoom</span><span class="token punctuation">:</span> 0.7<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>2024.7.4：新发现个bug，深色主题+<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>图标情况下，刷新页面可以实现深色主题保持，但是图标会切回初始的<span class="github-emoji"><span>🌙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f319.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><p>技术有限，不会图标保持操作，偷个懒，选择把图标固定为<code>fa fa-adjust</code>，同时将id改个名字</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sum-moon-icon1<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fa fa-adjust<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">zoom</span><span class="token punctuation">:</span> 0.7<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></blockquote><blockquote><p>20247.6：学习<a href="https://immortalqx.github.io/">LQX</a>博客发现，将黑夜模式判断放在<code>themes\hexo-theme-matery\source\js\matery.js</code>文件可以避免页面刷新时图标回到<span class="github-emoji"><span>🌙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f319.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 黑夜模式判断</span><span class="token keyword">if</span> <span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'isDark'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'DarkMode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#sum-moon-icon'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">"fa-sun"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'fa-moon'</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'DarkMode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#sum-moon-icon'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeleClass</span><span class="token punctuation">(</span><span class="token string">"fa-sun"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'fa-moon'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>原<code>themes\hexo-theme-matery\layout\layout.ejs</code>中模式判断可以注释掉</p></blockquote><h4 id="鼠标光标星星拖尾"><a href="#鼠标光标星星拖尾" class="headerlink" title="鼠标光标星星拖尾"></a>鼠标光标星星拖尾</h4><p>在<code>themes/hexo-theme-matery/source/js</code>文件夹下新建<code>cursor.js</code>文件，并将<a href="https://cdn.jsdelivr.net/gh/Yafine/cdn@3.2.5/source/js/cursor.js">传送门</a>内容粘贴进去</p><p>在<code>themes/hexo-theme-matery/layout/layout.ejs</code>内新增</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/cursor.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="樱花特效"><a href="#樱花特效" class="headerlink" title="樱花特效"></a>樱花特效</h4><p>Todo</p><h4 id="鼠标点击特效"><a href="#鼠标点击特效" class="headerlink" title="鼠标点击特效"></a>鼠标点击特效</h4><p>Todo</p><h4 id="修改页脚"><a href="#修改页脚" class="headerlink" title="修改页脚"></a>修改页脚</h4><p>修改的地方<code>themes/hexo-theme-matery/layout/_partial/footer.ejs</code>文件中，包括站点、使用的主题、访问量等</p><h4 id="修改网站背景"><a href="#修改网站背景" class="headerlink" title="修改网站背景"></a>修改网站背景</h4><p>修改主题配置文件对应参数，<code>themes/hexo-theme-matery/_config.yml</code></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 网站背景图</span><span class="token key atrule">background</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">url</span><span class="token punctuation">:</span> /medias/background.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="时光列表"><a href="#时光列表" class="headerlink" title="时光列表"></a>时光列表</h4><p>Todo</p><h4 id="脑图"><a href="#脑图" class="headerlink" title="脑图"></a>脑图</h4><p>安装脑图插件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-markmap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>绘图，可缩放，平移</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% markmap 400px %}<span class="token list punctuation">-</span> 下载node.js和git<span class="token list punctuation">-</span> hexo博客美化  <span class="token list punctuation">-</span> 美化：代码高亮，行号显示，搜索，字数统计，emoji，  <span class="token list punctuation">-</span> todo：看板娘，暗黑模式，樱花特效，右键定制，时光列表，个人相册  <span class="token list punctuation">-</span> 配置修改：个人简介，运行时间，主题颜色，文章加密，个人相册等{% endmarkmap %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>存在问题：latex公式显示异常，深色主题脑图文字不适配</p></blockquote><h3 id="模板配置修改"><a href="#模板配置修改" class="headerlink" title="模板配置修改"></a>模板配置修改</h3><p>修改根目录下<code>_config.yaml</code>配置</p><h4 id="个人信息"><a href="#个人信息" class="headerlink" title="个人信息"></a>个人信息</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> HeBlog<span class="token key atrule">subtitle</span><span class="token punctuation">:</span> <span class="token string">'苟日新，日日新，又日新'</span><span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">'记录学习之旅，巩固自我及启发后人'</span><span class="token key atrule">keywords</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>hexo<span class="token punctuation">,</span> 算法，计算机视觉，人工智能<span class="token punctuation">]</span><span class="token key atrule">author</span><span class="token punctuation">:</span> Achhhe<span class="token key atrule">language</span><span class="token punctuation">:</span> zh<span class="token punctuation">-</span>CN<span class="token key atrule">timezone</span><span class="token punctuation">:</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="主题配置修改"><a href="#主题配置修改" class="headerlink" title="主题配置修改"></a>主题配置修改</h3><h4 id="关闭contact和friends"><a href="#关闭contact和friends" class="headerlink" title="关闭contact和friends"></a>关闭contact和friends</h4><p>初始模板带有<code>Contact</code>和<code>Friends</code>选项，但是没有对应页面。如果不想创建，可以直接修改<code>/themes/hexo-theme-matery/_config.yaml</code>对应配置进行关闭</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">menu</span><span class="token punctuation">:</span>  <span class="token key atrule">Index</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>home  <span class="token key atrule">Tags</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /tags    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>tags  <span class="token key atrule">Categories</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /categories    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>bookmark  <span class="token key atrule">Archives</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /archives    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>archive  <span class="token key atrule">About</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /about    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>user<span class="token punctuation">-</span>circle  <span class="token comment">#Contact:</span>   <span class="token comment">#url: /contact</span>   <span class="token comment">#icon: fas fa-comments</span>  <span class="token comment">#Friends:</span>   <span class="token comment">#url: /friends</span>   <span class="token comment">#icon: fas fa-address-book</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="修改个人简介"><a href="#修改个人简介" class="headerlink" title="修改个人简介"></a>修改个人简介</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">profile</span><span class="token punctuation">:</span>  <span class="token key atrule">avatar</span><span class="token punctuation">:</span> /medias/avatar.jpg  <span class="token key atrule">career</span><span class="token punctuation">:</span> Algorithm Engineer  <span class="token key atrule">mySkills</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">data</span><span class="token punctuation">:</span>    <span class="token key atrule">Python</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'linear-gradient(to right, #FF0066 0%, #FF00CC 100%)'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 90%    <span class="token key atrule">Low Level Vision</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'linear-gradient(to right, #9900FF 0%, #CC66FF 100%)'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 90%    <span class="token key atrule">C/C++</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'linear-gradient(to right, #2196F3 0%, #42A5F5 100%)'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 60%    <span class="token key atrule">Self-Supervised Learning</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'linear-gradient(to right, #00BCD4 0%, #80DEEA 100%)'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 90%    <span class="token key atrule">Pytorch</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'linear-gradient(to right, #4CAF50 0%, #81C784 100%)'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 85%    <span class="token key atrule">Liveness Detection</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'linear-gradient(to right, #FFEB3B 0%, #FFF176 100%)'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 85%      <span class="token key atrule">githubLink</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/Achhhe  <span class="token key atrule">title</span><span class="token punctuation">:</span> Fork Me<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="站点初始运行时间"><a href="#站点初始运行时间" class="headerlink" title="站点初始运行时间"></a>站点初始运行时间</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 站点运行开始时间.</span><span class="token key atrule">time</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">year</span><span class="token punctuation">:</span> <span class="token number">2024</span> <span class="token comment"># 年份</span>  <span class="token key atrule">month</span><span class="token punctuation">:</span> <span class="token number">06</span> <span class="token comment"># 月份</span>  <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token number">29</span> <span class="token comment"># 日期</span>  <span class="token key atrule">hour</span><span class="token punctuation">:</span> <span class="token number">00</span> <span class="token comment"># 小时</span>  <span class="token key atrule">minute</span><span class="token punctuation">:</span> <span class="token number">00</span> <span class="token comment"># 分钟</span>  <span class="token key atrule">second</span><span class="token punctuation">:</span> <span class="token number">00</span> <span class="token comment"># 秒</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="其他打开或关闭"><a href="#其他打开或关闭" class="headerlink" title="其他打开或关闭"></a>其他打开或关闭</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">mathjax</span><span class="token punctuation">:</span>  <span class="token comment"># 数学公式，全局开关</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">music</span><span class="token punctuation">:</span>   <span class="token comment"># 音乐插件</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">2097531989</span>  <span class="token comment"># 对应歌单id</span>  <span class="token key atrule">reward</span><span class="token punctuation">:</span>  <span class="token comment"># 打赏功能</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">myProjects</span><span class="token punctuation">:</span>  <span class="token comment"># 个人工程</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">myGallery</span><span class="token punctuation">:</span>   <span class="token comment"># 个人相册</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">ribbon_dynamic</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">sharejs</span><span class="token punctuation">:</span>  <span class="token comment">#分享模块</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">sites</span><span class="token punctuation">:</span> qq<span class="token punctuation">,</span>qzone<span class="token punctuation">,</span>wechat<span class="token punctuation">,</span>weibo<span class="token punctuation">,</span>google<span class="token key atrule">verifyPassword</span><span class="token punctuation">:</span>  <span class="token comment"># 文章验证密码 SHA256加密</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其他配置可根据个人喜好进行修改，包括：</p><blockquote><ul><li>菜单</li><li>我的梦想</li><li>首页的音乐播放器和视频播放器配置</li><li>是否显示推荐文章名称和按钮配置</li><li><code>favicon</code> 和 <code>Logo</code></li><li><strong>个人信息</strong></li><li><strong>文章加密</strong></li><li>TOC 目录</li><li>文章打赏信息</li><li>复制文章内容时追加版权信息</li><li><strong>MathJax</strong></li><li><strong>文章字数统计、阅读时长</strong></li><li>点击页面的’爱心’效果</li><li>我的项目</li><li><strong>我的技能</strong></li><li><strong>我的相册</strong></li><li><code>Gitalk</code>、<code>Gitment</code>、<code>Valine</code> 和 <code>disqus</code> 评论配置</li><li><a href="http://busuanzi.ibruce.info/">不蒜子统计</a>和谷歌分析（<code>Google Analytics</code>）</li><li>默认特色图的集合。当文章没有设置特色图时，本主题会根据文章标题的 <code>hashcode</code> 值取余，来选择展示对应的特色图</li></ul></blockquote><p>如果不满意本主题中的诸多功能和主题色彩，可以在主题中自定义修改，很多更自由的功能和细节点的修改难以在主题的 <code>_config.yml</code> 中完成，需要修改源代码才来完成</p><p>以下列出修改颜色和图片</p><h4 id="修改主题颜色"><a href="#修改主题颜色" class="headerlink" title="修改主题颜色"></a>修改主题颜色</h4><p>在主题文件的 <code>/source/css/matery.css</code> 文件中，搜索 <code>.bg-color</code> 来修改背景颜色：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 整体背景颜色，包括导航、移动端的导航、页尾、标签页等的背景颜色. */</span><span class="token selector">.bg-color</span> <span class="token punctuation">{</span>    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>45deg<span class="token punctuation">,</span> <span class="token function">rgba</span><span class="token punctuation">(</span>200<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">)</span> 40%<span class="token punctuation">,</span> <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>200<span class="token punctuation">,</span>0.5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token atrule"><span class="token rule">@-webkit-keyframes</span> rainbow</span> <span class="token punctuation">{</span>   <span class="token comment">/* 动态切换背景颜色. */</span><span class="token punctuation">}</span><span class="token atrule"><span class="token rule">@keyframes</span> rainbow</span> <span class="token punctuation">{</span>    <span class="token comment">/* 动态切换背景颜色. */</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CSS函数<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/gradient/linear-gradient">linear-gradient</a>创建一个由两种或多种颜色沿一条直线进行线性过渡的图像</p><p>本博客设置$45^{\circ}$渐变，起始为红色系，在$40$%处变为蓝色系</p><h4 id="修改-banner-图和文章特色图"><a href="#修改-banner-图和文章特色图" class="headerlink" title="修改 banner 图和文章特色图"></a>修改 banner 图和文章特色图</h4><p>你可以直接在 <code>/source/medias/banner</code> 文件夹中更换你喜欢的 <code>banner</code> 图片，主题代码中是每天动态切换一张，只需 <code>7</code> 张即可。如果你会 <code>JavaScript</code> 代码，可以修改成你自己喜欢切换逻辑，如：随机切换等，<code>banner</code> 切换的代码位置在 <code>/layout/_partial/bg-cover-content.ejs</code> 文件的 `` 代码中：</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">$('.bg-cover').css('background-image', 'url(/medias/banner/' + new Date().getDay() + '.jpg)');<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 <code>/source/medias/featureimages</code> 文件夹中默认有 24 张特色图片，你可以再增加或者减少，并需要在 <code>_config.yml</code> 做同步修改。</p><blockquote><p>banner图太大可能显示红色背景，<a href="https://github.com/blinkfox/hexo-theme-matery/issues/528">传送门</a></p><p>图片源自<a href="https://immortalqx.github.io/">LQX</a>博客，感谢<span class="github-emoji"><span>😃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f603.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.csdn.net/dm900work/article/details/121332092">行号显示</a></p><p><a href="https://blog.dreamruins.com/tutorials/1121281946">暗黑主题-Ruins</a></p><p><a href="https://blog.17lai.site/posts/4a2050e2/">夜法之书</a></p><p><a href="https://immortalqx.github.io/">LQX</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> 博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo+matery博客搭建之插入图片</title>
      <link href="/2024/06/30/insert-image-in-hexo/"/>
      <url>/2024/06/30/insert-image-in-hexo/</url>
      
        <content type="html"><![CDATA[<div class="markmap-container" style="height:400px">  <svg data="{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;全局资源文件夹&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;新建<code>images</code>文件夹&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;<code>![](/images/my-first-post-2.png)</code>访问&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;最简单，方便快捷，但文章较多时资源混乱&quot;}]},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;文章资源文件夹&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[6,7]},&quot;v&quot;:&quot;<code>post_asset_folder</code>值为<code>true</code>&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[7,8]},&quot;v&quot;:&quot;通过<code>asset_img</code>相对路径访问&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[8,9]},&quot;v&quot;:&quot;各文章资源独立，规范化管理&quot;}]}],&quot;p&quot;:{}}"></svg></div><blockquote><p>脑图可拖动和放缩</p></blockquote><h3 id="全局资源文件夹"><a href="#全局资源文件夹" class="headerlink" title="全局资源文件夹"></a>全局资源文件夹</h3><p>在<code>source</code>文件夹下新建一个<code>images</code>文件夹，把所有文章的图片资源都放里面，markdown文档内直接<code>![](/images/my-first-post-2.png)</code>访问。注意，<code>/</code>指的是根目录，对于hexo，<code>source</code>就是资源文件的根目录</p><p><img src="/images/my-first-post-2.png"></p><p>优点：方便快捷，统一管理，方便文件多次调</p><p>缺点：文章较多时资源混乱</p><h3 id="文章资源文件夹"><a href="#文章资源文件夹" class="headerlink" title="文章资源文件夹"></a>文章资源文件夹</h3><p>对于每篇文章单独建立一个资源文件夹，各自独立管理</p><p>修改<code>_config.yaml</code>中的<code>post_asset_folder</code>值为<code>true</code></p><p><code>hexo new 'title'</code>创建新post以后，会在<code>_post</code>文件夹下创建同名的文件夹和markdown文件，将图片资源(本文为<code>my-first-post-2-1.png</code>)放置文件夹内，可通过<code>asset_img</code>直接相对路径访问，markdown调节路径会比较繁琐</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token punctuation">{</span>% asset_img my-first-post-2-1.png 文章资源文件夹图片展示 %<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><img src="/2024/06/30/insert-image-in-hexo/my-first-post-2-1.png" class="" title="文章资源文件夹图片展示"><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://hexo.io/zh-cn/docs/asset-folders">hexo中文文档</a></p><p><a href="https://blog.csdn.net/2301_77285173/article/details/130189857">在hexo博客中插入图片的方法</a></p><p><a href="https://blog.17lai.site/posts/cf0f47fd/#%E8%84%91%E5%9B%BE">夜法之书</a></p><p><a href="https://github.com/MaxChang3/hexo-markmap/blob/main/README_HANS.md">脑图</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo+matery博客搭建之框架搭建</title>
      <link href="/2024/06/29/my-first-post/"/>
      <url>/2024/06/29/my-first-post/</url>
      
        <content type="html"><![CDATA[<div class="markmap-container" style="height:400px">  <svg data="{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;下载node.js和git&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;hexo搭建博客&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;下载node.js和git&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;搭建博客&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:6,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;更换主题，新建post，新建page&quot;}]}]}],&quot;p&quot;:{}}"></svg></div><blockquote><p>脑图可拖动和放缩</p></blockquote><h2 id="下载node-js和git"><a href="#下载node-js和git" class="headerlink" title="下载node.js和git"></a>下载node.js和git</h2><p>node.js直接<a href="https://nodejs.org/zh-cn">官网</a>下载</p><p>git从<a href="https://registry.npmmirror.com/binary.html?path=git-for-windows/">阿里镜像</a>下载，直接下载最新的<a href="https://registry.npmmirror.com/binary.html?path=git-for-windows/v2.45.2.windows.1/">v2.45.2.windows.1/</a></p><p>直接默认安装配置即可，环境变量会默认添加</p><h2 id="基于hexo框架搭建博客"><a href="#基于hexo框架搭建博客" class="headerlink" title="基于hexo框架搭建博客"></a>基于hexo框架搭建博客</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-cli <span class="token parameter variable">-g</span>  <span class="token comment"># 安装hexo框架</span><span class="token builtin class-name">cd</span> xxx                   <span class="token comment"># 切换至自定义博客保存目录</span>hexo init blog           <span class="token comment"># 生成并初始化博客至blog目录</span><span class="token builtin class-name">cd</span> bloghexo s                   <span class="token comment"># hexo server，启动本地博客服务</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本地浏览器<code>http://localhost:4000/</code>可以看到如下</p><p><img src="/images/my-first-post-1.png"></p><h3 id="必备操作"><a href="#必备操作" class="headerlink" title="必备操作"></a>必备操作</h3><h4 id="Create-Your-First-Post"><a href="#Create-Your-First-Post" class="headerlink" title="Create Your First Post"></a>Create Your First Post</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new <span class="token string">'my first post'</span>     <span class="token comment"># 创建新post</span>hexo s                       <span class="token comment"># 启动server</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上述指令将创建文件至<code>\blog\source\_posts\my-first-post.md</code>，可基于<code>markdown</code>编写内容</p><p><strong>Front-matter</strong>简单示例</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">title: My First Postdate: 2024-06-29 13:47:03mathjax: true   #打开数据公式局部开关categories: 博客搭建tags:  <span class="token list punctuation">-</span> Hexo  <span class="token list punctuation">-</span> 博客搭建 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Front-matter</strong>最全示例</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> xxx<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-07 09:25:00</span><span class="token key atrule">author</span><span class="token punctuation">:</span> Achhhe<span class="token key atrule">img</span><span class="token punctuation">:</span> /source/images/xxx.jpg<span class="token key atrule">top</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">hide</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">coverImg</span><span class="token punctuation">:</span> /images/1.jpg<span class="token key atrule">password</span><span class="token punctuation">:</span> 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92<span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">mathjax</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">summary</span><span class="token punctuation">:</span> xxx<span class="token key atrule">categories</span><span class="token punctuation">:</span> xxx<span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> xxx  <span class="token punctuation">-</span> yyy</span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="更换主题"><a href="#更换主题" class="headerlink" title="更换主题"></a>更换主题</h4><p>去<a href="https://blinkfox.github.io/">闪烁之狐</a>主页下载稳定版主题文件<code>hexo-theme-matery-master.zip</code>，解压至<code>blog/theme</code></p><p>修改hexo根目录下<code>_config.yaml</code>配置文件中<code>theme</code>值为<code>theme: hexo-theme-matery</code></p><p>注意：主题压缩文件直接解压的文件夹名称为<code>hexo-theme-matery-master</code>，需要修改成<code>hexo-theme-matery</code>（即<code>blog/theme</code>文件夹下主题文件夹名称应和<code>_config.yaml</code>的<code>theme</code>值相同）</p><p>最终效果如下</p><p><img src="/images/my-first-post-2.png"></p><p>具体修改见下文</p><h4 id="新建分类-categories-页"><a href="#新建分类-categories-页" class="headerlink" title="新建分类 categories 页"></a>新建分类 categories 页</h4><p><code>categories</code> 页是用来展示所有分类的页面。初始模板 <code>source</code> 目录下还没有 <code>categories/index.md</code> 文件，需要新建一个，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"categories"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑你刚刚新建的页面文件 <code>/source/categories/index.md</code>，至少需要以下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> categories<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 17:25:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="新建标签-tags-页"><a href="#新建标签-tags-页" class="headerlink" title="新建标签 tags 页"></a>新建标签 tags 页</h4><p><code>tags</code> 页是用来展示所有标签的页面。初始博客 <code>source</code> 目录下还没有 <code>tags/index.md</code> 文件，需要新建一个，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"tags"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑你刚刚新建的页面文件 <code>/source/tags/index.md</code>，至少需要以下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> tags<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 18:23:38</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="新建关于我-about-页"><a href="#新建关于我-about-页" class="headerlink" title="新建关于我 about 页"></a>新建关于我 about 页</h4><p><code>about</code> 页是用来展示<strong>关于我和我的博客</strong>信息的页面。初始博客 <code>source</code> 目录下还没有 <code>about/index.md</code> 文件，那么你就需要新建一个，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"about"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑你刚刚新建的页面文件 <code>/source/about/index.md</code>，至少需要以下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> about<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 17:25:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"about"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"about"</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md">matery模板安装教程</a></p><p><a href="https://hexo.io/zh-cn/docs/">hexo中文文档</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
      
      
      <categories>
          
          <category> 博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
